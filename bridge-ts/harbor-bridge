#!/bin/bash
# Workaround for SSL certificate verification issues with Node.js
# TODO: Properly configure CA certificates instead
export NODE_TLS_REJECT_UNAUTHORIZED=0
# Suppress ALL Node.js output that could corrupt native messaging JSON protocol
export NODE_NO_WARNINGS=1

# Load OAuth credentials from credentials.env if it exists
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
CREDENTIALS_FILE="$SCRIPT_DIR/../installer/credentials.env"
if [ -f "$CREDENTIALS_FILE" ]; then
  # Source the file, but only export HARBOR_* variables
  set -a
  source "$CREDENTIALS_FILE"
  set +a
fi

# Redirect stderr to a log file for debugging, keep stdout clean for native messaging
exec /opt/homebrew/bin/node --no-warnings --no-deprecation "/Users/raffi/stuff/code/harbor/bridge-ts/dist/main.js" 2>>"$HOME/.harbor/bridge.log"
