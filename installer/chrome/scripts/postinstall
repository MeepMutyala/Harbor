#!/bin/bash
# Harbor Chrome Installer - Post-install setup
# This script runs after files are copied to set up native messaging and Chrome extension

set -e

LOG_FILE="/tmp/harbor-chrome-install.log"
echo "Harbor Chrome post-install started at $(date)" >> "$LOG_FILE"

# Installation paths
HARBOR_DIR="/Library/Application Support/Harbor"
HARBOR_BIN="$HARBOR_DIR/harbor-bridge"
CHROME_EXTENSION_DIR="$HARBOR_DIR/chrome-extension"
WEB_AGENTS_EXTENSION_DIR="$HARBOR_DIR/web-agents-chrome"

# =============================================================================
# Select correct binary for current architecture
# =============================================================================
select_binary() {
    echo "Selecting binary for current architecture..."
    
    # Use sysctl to detect native architecture (works even under Rosetta)
    if sysctl -n hw.optional.arm64 2>/dev/null | grep -q "1"; then
        ARCH="arm64"
    else
        ARCH=$(uname -m)
    fi
    echo "  Detected architecture: $ARCH" >> "$LOG_FILE"
    
    if [ "$ARCH" = "arm64" ]; then
        BINARY_SOURCE="$HARBOR_DIR/harbor-bridge-arm64"
    else
        BINARY_SOURCE="$HARBOR_DIR/harbor-bridge-x64"
    fi
    
    if [ -f "$BINARY_SOURCE" ]; then
        # Copy the correct binary
        cp "$BINARY_SOURCE" "$HARBOR_BIN"
        chmod +x "$HARBOR_BIN"
        echo "  ✓ Selected $ARCH binary"
        echo "  Selected binary: $BINARY_SOURCE -> $HARBOR_BIN" >> "$LOG_FILE"
        
        # Clean up both architecture-specific binaries
        rm -f "$HARBOR_DIR/harbor-bridge-arm64" 2>/dev/null || true
        rm -f "$HARBOR_DIR/harbor-bridge-x64" 2>/dev/null || true
    elif [ -f "$HARBOR_BIN" ]; then
        # Single-arch build already has the binary in place
        echo "  ✓ Using pre-built binary"
        echo "  Using pre-built binary at: $HARBOR_BIN" >> "$LOG_FILE"
    else
        echo "  ✗ ERROR: No suitable binary found for $ARCH!" | tee -a "$LOG_FILE"
        exit 1
    fi
}

# Native messaging paths for Chromium-based browsers
CHROME_NATIVE_HOSTS="/Library/Application Support/Google/Chrome/NativeMessagingHosts"
CHROMIUM_NATIVE_HOSTS="/Library/Application Support/Chromium/NativeMessagingHosts"
EDGE_NATIVE_HOSTS="/Library/Application Support/Microsoft Edge/NativeMessagingHosts"
BRAVE_NATIVE_HOSTS="/Library/Application Support/BraveSoftware/Brave-Browser/NativeMessagingHosts"
ARC_NATIVE_HOSTS="/Library/Application Support/Arc/User Data/NativeMessagingHosts"
VIVALDI_NATIVE_HOSTS="/Library/Application Support/Vivaldi/NativeMessagingHosts"
MANIFEST_NAME="harbor_bridge"

# =============================================================================
# Create launcher script
# =============================================================================
create_launcher() {
    echo "Creating launcher script..."
    
    LAUNCHER_SCRIPT="$HARBOR_DIR/harbor-bridge-launcher"
    
    cat > "$LAUNCHER_SCRIPT" << 'LAUNCHER_EOF'
#!/bin/bash
# Harbor Bridge Launcher
# Wrapper script for native messaging

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Suppress Node.js warnings that could corrupt the native messaging protocol
export NODE_NO_WARNINGS=1

# Tell pkg where to find native modules (better-sqlite3)
export PKG_EXECPATH="$SCRIPT_DIR/harbor-bridge"

# Log file for debugging
LOG_FILE="$HOME/.harbor/bridge.log"
mkdir -p "$(dirname "$LOG_FILE")"

# Execute the bridge, redirecting stderr to log file
exec "$SCRIPT_DIR/harbor-bridge" 2>>"$LOG_FILE"
LAUNCHER_EOF

    chmod +x "$LAUNCHER_SCRIPT"
    echo "Launcher script created at: $LAUNCHER_SCRIPT" >> "$LOG_FILE"
}

# =============================================================================
# Install native messaging manifest for a Chromium-based browser
# =============================================================================
install_chrome_native_manifest_for_browser() {
    local BROWSER_NAME="$1"
    local HOSTS_DIR="$2"
    
    echo "  Installing native messaging manifest for $BROWSER_NAME..."
    
    LAUNCHER_PATH="$HARBOR_DIR/harbor-bridge-launcher"
    
    # Create directory if it doesn't exist
    mkdir -p "$HOSTS_DIR"
    
    MANIFEST_FILE="$HOSTS_DIR/${MANIFEST_NAME}.json"
    
    # For unpacked extensions, allowed_origins starts empty
    # The user will run configure-extension-id.sh to add their extension ID
    # after loading the unpacked extension in Chrome developer mode
    ORIGINS="[]"
    
    cat > "$MANIFEST_FILE" << EOF
{
  "name": "$MANIFEST_NAME",
  "description": "Harbor Bridge - AI Agent Platform with MCP Tools",
  "path": "$LAUNCHER_PATH",
  "type": "stdio",
  "allowed_origins": $ORIGINS
}
EOF

    echo "$BROWSER_NAME native manifest installed at: $MANIFEST_FILE" >> "$LOG_FILE"
    echo "    ✓ $BROWSER_NAME: $MANIFEST_FILE"
}

# =============================================================================
# Install native messaging manifests for all Chromium browsers
# =============================================================================
install_chrome_native_manifests() {
    echo "Installing Chrome native messaging manifests..."
    
    # Install for Google Chrome
    if [ -d "/Applications/Google Chrome.app" ]; then
        install_chrome_native_manifest_for_browser "Chrome" "$CHROME_NATIVE_HOSTS"
    fi
    
    # Install for Chromium
    if [ -d "/Applications/Chromium.app" ]; then
        install_chrome_native_manifest_for_browser "Chromium" "$CHROMIUM_NATIVE_HOSTS"
    fi
    
    # Install for Microsoft Edge
    if [ -d "/Applications/Microsoft Edge.app" ]; then
        install_chrome_native_manifest_for_browser "Edge" "$EDGE_NATIVE_HOSTS"
    fi
    
    # Install for Brave
    if [ -d "/Applications/Brave Browser.app" ]; then
        install_chrome_native_manifest_for_browser "Brave" "$BRAVE_NATIVE_HOSTS"
    fi
    
    # Install for Arc
    if [ -d "/Applications/Arc.app" ]; then
        install_chrome_native_manifest_for_browser "Arc" "$ARC_NATIVE_HOSTS"
    fi
    
    # Install for Vivaldi
    if [ -d "/Applications/Vivaldi.app" ]; then
        install_chrome_native_manifest_for_browser "Vivaldi" "$VIVALDI_NATIVE_HOSTS"
    fi
    
    # Also update user-level manifests if they exist
    update_user_chrome_manifests
}

# =============================================================================
# Update user-level Chrome native messaging manifests
# =============================================================================
update_user_chrome_manifests() {
    ACTUAL_USER="${SUDO_USER:-}"
    if [ -z "$ACTUAL_USER" ]; then
        ACTUAL_USER=$(stat -f '%Su' /dev/console 2>/dev/null || echo "")
    fi
    
    if [ -z "$ACTUAL_USER" ] || [ "$ACTUAL_USER" = "root" ]; then
        return 0
    fi
    
    USER_HOME=$(eval echo "~$ACTUAL_USER")
    LAUNCHER_PATH="$HARBOR_DIR/harbor-bridge-launcher"
    
    # For unpacked extensions, start with empty origins
    ORIGINS="[]"
    
    # Check and update user Chrome manifest
    USER_CHROME_DIR="$USER_HOME/Library/Application Support/Google/Chrome/NativeMessagingHosts"
    if [ -d "$USER_CHROME_DIR" ]; then
        cat > "$USER_CHROME_DIR/${MANIFEST_NAME}.json" << EOF
{
  "name": "$MANIFEST_NAME",
  "description": "Harbor Bridge - AI Agent Platform with MCP Tools",
  "path": "$LAUNCHER_PATH",
  "type": "stdio",
  "allowed_origins": $ORIGINS
}
EOF
        chown "$ACTUAL_USER" "$USER_CHROME_DIR/${MANIFEST_NAME}.json"
        echo "    ✓ Updated user Chrome manifest"
    fi
}

# =============================================================================
# Install extension configuration helper and setup assistant
# =============================================================================
install_chrome_extension() {
    echo "Setting up Chrome extension tools..."
    
    # Get the actual user
    ACTUAL_USER="${SUDO_USER:-}"
    if [ -z "$ACTUAL_USER" ]; then
        ACTUAL_USER=$(stat -f '%Su' /dev/console 2>/dev/null || echo "")
    fi
    
    # Copy the configure-extension-id.sh script
    if [ -f "$HARBOR_DIR/configure-extension-id.sh" ]; then
        chmod +x "$HARBOR_DIR/configure-extension-id.sh"
        echo "  ✓ Extension ID configuration script installed"
    fi
    
    # Build Setup Assistant app from AppleScript
    build_setup_assistant
    
    # Show instructions
    echo ""
    echo "  Chrome extension requires manual loading (Developer Mode):"
    echo ""
    echo "    1. Open Chrome → chrome://extensions/"
    echo "    2. Enable 'Developer mode' (top right toggle)"
    echo "    3. Click 'Load unpacked'"
    echo "    4. Select: $CHROME_EXTENSION_DIR"
    echo ""
    
    if [ -d "$WEB_AGENTS_EXTENSION_DIR" ]; then
        echo "  For Web Agents extension, also load:"
        echo "    $WEB_AGENTS_EXTENSION_DIR"
        echo ""
    fi
}

# =============================================================================
# Build and install Setup Assistant app
# =============================================================================
build_setup_assistant() {
    echo "Building Setup Assistant..."
    
    SETUP_SCRIPT="$HARBOR_DIR/setup-assistant.applescript"
    SETUP_APP="/Applications/Harbor Setup.app"
    
    if [ -f "$SETUP_SCRIPT" ]; then
        # Build the app from AppleScript
        if osacompile -o "$SETUP_APP" "$SETUP_SCRIPT" 2>> "$LOG_FILE"; then
            echo "  ✓ Setup Assistant installed: $SETUP_APP"
            echo "Setup Assistant built: $SETUP_APP" >> "$LOG_FILE"
        else
            echo "  ⚠ Could not build Setup Assistant app"
            echo "Failed to build Setup Assistant" >> "$LOG_FILE"
        fi
    else
        echo "  ⚠ Setup Assistant script not found"
        echo "setup-assistant.applescript not found" >> "$LOG_FILE"
    fi
}

# =============================================================================
# Launch Setup Assistant for the user
# =============================================================================
launch_setup_assistant() {
    echo "Launching Setup Assistant..."
    
    ACTUAL_USER="${SUDO_USER:-}"
    if [ -z "$ACTUAL_USER" ]; then
        ACTUAL_USER=$(stat -f '%Su' /dev/console 2>/dev/null || echo "")
    fi
    
    SETUP_APP="/Applications/Harbor Setup.app"
    
    if [ -d "$SETUP_APP" ] && [ -n "$ACTUAL_USER" ] && [ "$ACTUAL_USER" != "root" ]; then
        # Launch the setup assistant as the actual user (in background, don't block installer)
        su "$ACTUAL_USER" -c "open '$SETUP_APP'" 2>> "$LOG_FILE" &
        echo "  ✓ Setup Assistant launched"
        echo "Setup Assistant launched for user $ACTUAL_USER" >> "$LOG_FILE"
    else
        echo "  ⚠ Could not launch Setup Assistant automatically"
        echo "    Launch manually: /Applications/Harbor Setup.app"
    fi
}

# =============================================================================
# Set permissions
# =============================================================================
set_permissions() {
    echo "Setting permissions..."
    
    # Make the bridge executable
    chmod +x "$HARBOR_BIN"
    
    # Make the uninstall script executable
    if [ -f "$HARBOR_DIR/uninstall.sh" ]; then
        chmod +x "$HARBOR_DIR/uninstall.sh"
    fi
    
    echo "Permissions set" >> "$LOG_FILE"
}

# =============================================================================
# Install uninstaller
# =============================================================================
install_uninstaller() {
    echo "Installing uninstaller..."
    
    # Create CLI symlink
    if [ -d "/usr/local/bin" ]; then
        ln -sf "$HARBOR_DIR/uninstall.sh" "/usr/local/bin/harbor-uninstall"
        echo "  ✓ CLI uninstaller: harbor-uninstall"
    fi
    
    # Create uninstaller app from AppleScript
    if [ -d "$HARBOR_DIR/Uninstall Harbor.app" ]; then
        cp -R "$HARBOR_DIR/Uninstall Harbor.app" "/Applications/"
        echo "  ✓ Uninstaller app: /Applications/Uninstall Harbor.app"
    fi
    
    echo "Uninstaller installed" >> "$LOG_FILE"
}

# =============================================================================
# Install Ollama (for Local LLM support)
# =============================================================================
install_ollama() {
    echo "Setting up Ollama for Local LLM..."
    
    # Check if Ollama is already installed
    if command -v ollama &> /dev/null; then
        OLLAMA_VERSION=$(ollama --version 2>/dev/null | head -1 || echo "installed")
        echo "  ✓ Ollama already installed: $OLLAMA_VERSION"
        echo "Ollama already installed: $OLLAMA_VERSION" >> "$LOG_FILE"
        return 0
    fi
    
    # Check if we can install (need network)
    if ! ping -c 1 ollama.com &> /dev/null; then
        echo "  ⚠ Cannot reach ollama.com - skipping Ollama installation"
        echo "    Install Ollama later with: brew install ollama"
        echo "    Or download from: https://ollama.com"
        echo "Cannot reach ollama.com, skipping Ollama install" >> "$LOG_FILE"
        return 0
    fi
    
    # Get the actual user
    ACTUAL_USER="${SUDO_USER:-}"
    if [ -z "$ACTUAL_USER" ]; then
        ACTUAL_USER=$(stat -f '%Su' /dev/console 2>/dev/null || echo "")
    fi
    
    echo "  Downloading Ollama..."
    echo "Downloading Ollama for user: $ACTUAL_USER" >> "$LOG_FILE"
    
    # Create temp directory
    OLLAMA_TEMP="/tmp/harbor-ollama-install"
    mkdir -p "$OLLAMA_TEMP"
    
    # Download Ollama
    OLLAMA_URL="https://ollama.com/download/Ollama-darwin.zip"
    OLLAMA_ZIP="$OLLAMA_TEMP/Ollama.zip"
    
    if curl -sL "$OLLAMA_URL" -o "$OLLAMA_ZIP" 2>> "$LOG_FILE"; then
        echo "  Extracting Ollama..."
        
        cd "$OLLAMA_TEMP"
        unzip -q "$OLLAMA_ZIP" -d "$OLLAMA_TEMP" 2>> "$LOG_FILE"
        
        if [ -d "$OLLAMA_TEMP/Ollama.app" ]; then
            rm -rf "/Applications/Ollama.app" 2>/dev/null || true
            mv "$OLLAMA_TEMP/Ollama.app" "/Applications/"
            
            echo "  ✓ Ollama installed to /Applications/Ollama.app"
            echo "Ollama installed to /Applications" >> "$LOG_FILE"
            
            if [ -n "$ACTUAL_USER" ] && [ "$ACTUAL_USER" != "root" ]; then
                echo "  Starting Ollama..."
                su "$ACTUAL_USER" -c "open -a Ollama" 2>> "$LOG_FILE" &
                echo "  ✓ Ollama started"
            fi
        else
            echo "  ⚠ Ollama extraction failed - install manually"
            echo "Ollama extraction failed" >> "$LOG_FILE"
        fi
        
        rm -rf "$OLLAMA_TEMP"
    else
        echo "  ⚠ Ollama download failed - install manually"
        echo "    Run: brew install ollama"
        echo "Ollama download failed" >> "$LOG_FILE"
        rm -rf "$OLLAMA_TEMP"
    fi
}

# =============================================================================
# Create first-run marker
# =============================================================================
create_first_run_marker() {
    ACTUAL_USER="${SUDO_USER:-}"
    if [ -z "$ACTUAL_USER" ]; then
        ACTUAL_USER=$(stat -f '%Su' /dev/console 2>/dev/null || echo "")
    fi
    
    if [ -z "$ACTUAL_USER" ] || [ "$ACTUAL_USER" = "root" ]; then
        echo "Could not determine actual user for marker, skipping" >> "$LOG_FILE"
        return 0
    fi
    
    USER_HOME=$(eval echo "~$ACTUAL_USER")
    MARKER_DIR="$USER_HOME/.harbor"
    
    su "$ACTUAL_USER" -c "mkdir -p '$MARKER_DIR'"
    
    if [ ! -f "$MARKER_DIR/.installed" ]; then
        su "$ACTUAL_USER" -c "cat > '$MARKER_DIR/.installed'" << EOF
first_install=$(date +%s)
show_welcome=true
browser=chrome
EOF
        echo "First-run marker created for $ACTUAL_USER" >> "$LOG_FILE"
    else
        echo "Upgrade marker exists for $ACTUAL_USER" >> "$LOG_FILE"
    fi
}

# =============================================================================
# Main installation
# =============================================================================

echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "  Harbor Chrome - Post-Installation Setup"
echo "═══════════════════════════════════════════════════════════════"
echo ""

# Run installation steps
select_binary
set_permissions
create_launcher
install_chrome_native_manifests
install_ollama
install_chrome_extension
install_uninstaller
create_first_run_marker

# Launch the Setup Assistant to guide the user
launch_setup_assistant

echo ""
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "✓ Harbor has been installed successfully!"
echo ""
echo "SETUP ASSISTANT:"
echo "  The Harbor Setup Assistant should have opened to guide you"
echo "  through loading the Chrome extension."
echo ""
echo "  If it didn't open, launch it manually:"
echo "    /Applications/Harbor Setup.app"
echo ""
echo "  Or set up manually:"
echo "    1. Open Chrome → chrome://extensions/"
echo "    2. Enable 'Developer mode' (top right toggle)"
echo "    3. Click 'Load unpacked'"
echo "    4. Select: $CHROME_EXTENSION_DIR"
echo "    5. Note the extension ID (32-character string)"
echo "    6. Run: $HARBOR_DIR/configure-extension-id.sh"
echo ""
echo "LOCAL LLM:"
echo "  Ollama provides fast, local AI using your Mac's GPU."
echo "  If Ollama wasn't installed, run: brew install ollama"
echo ""
echo "To uninstall Harbor later:"
echo "  • Double-click 'Uninstall Harbor' in /Applications"
echo "  • Or run: harbor-uninstall"
echo ""
echo "═══════════════════════════════════════════════════════════════"

echo "Post-install completed successfully at $(date)" >> "$LOG_FILE"
exit 0
