<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Web Agent Control ‚Äî Scroll & Wait</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../shared/styles.css" />
  <link rel="stylesheet" href="../shared/styles.css" />
  <script src="../shared/agent.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: var(--demo-space-10) 0;
    }

    .scroll-shell {
      height: 420px;
      overflow: auto;
      border-radius: var(--demo-radius-lg);
      border: 1px solid var(--demo-border-subtle);
      background: var(--demo-bg-base);
      padding: var(--demo-space-4);
      display: grid;
      gap: var(--demo-space-3);
    }

    .scroll-card {
      padding: var(--demo-space-4);
      border-radius: var(--demo-radius-md);
      border: 1px solid var(--demo-border-subtle);
      background: var(--demo-bg-elevated);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: var(--demo-text-sm);
    }

    .scroll-card span {
      color: var(--demo-text-secondary);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--demo-space-3);
    }

    .reward-banner {
      display: none;
      padding: var(--demo-space-4);
      border-radius: var(--demo-radius-lg);
      border: 1px solid var(--demo-success);
      background: var(--demo-success-dim);
      color: var(--demo-success);
      font-weight: var(--demo-weight-semibold);
      align-items: center;
      justify-content: space-between;
    }

    .reward-banner.is-visible {
      display: flex;
    }

    .status-list {
      display: grid;
      gap: var(--demo-space-3);
      font-size: var(--demo-text-sm);
      color: var(--demo-text-secondary);
    }

  </style>
</head>
<body class="demo-bg-grid">
  <main class="page-container">
    <header class="demo-header">
      <div class="header-badge">
        <span class="dot"></span>
        <span>Interactive Walkthrough</span>
      </div>
      <h1 class="demo-title demo-text-gradient">Scroll &amp; Wait</h1>
      <p class="demo-subtitle">Scroll through a long list, load more items, and wait for delayed elements.</p>
    </header>

    <div class="demo-flex demo-flex-col demo-gap-6">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
      </div>
      <div class="checklist" id="walkthrough-steps"></div>
      <div class="walkthrough-controls">
        <button id="walkthrough-reset" class="demo-btn demo-btn-secondary" type="button" style="display: none;">
          ‚Ü∫ Start Over
        </button>
        <button id="walkthrough-next" class="demo-btn demo-btn-primary" type="button">Run Step 1 ‚Üí</button>
      </div>

      <section class="demo-card">
        <div class="demo-card-header">
          <div class="demo-card-icon">üìú</div>
          <div>
            <div class="demo-card-title">Scrollable Queue</div>
            <p class="demo-text-sm">Use <code>scroll</code> and <code>waitForSelector</code> here.</p>
          </div>
        </div>

        <div class="scroll-shell" id="scroll-shell" aria-label="Scrollable backlog">
          <!-- Cards inserted by script -->
        </div>

        <div class="demo-mt-6 controls">
          <button id="load-more" class="demo-btn demo-btn-primary" type="button">Load more</button>
          <button id="reveal-delay" class="demo-btn demo-btn-secondary" type="button">Reveal after delay</button>
          <button id="scroll-reset" class="demo-btn demo-btn-ghost" type="button">Reset</button>
        </div>

        <div class="demo-mt-6 reward-banner" id="reward-banner">
          üéâ Milestone reached ‚Äî hidden target unlocked
          <span id="reward-id">target: #reward-banner</span>
        </div>
      </section>

      <section class="demo-card">
        <div class="demo-card-header">
          <div class="demo-card-icon">üìå</div>
          <div>
            <div class="demo-card-title">Status</div>
            <p class="demo-text-sm">Updated as you interact.</p>
          </div>
        </div>
        <div class="status-list" id="status-list">
          <div>Total items: <strong id="status-count">0</strong></div>
          <div>Last action: <strong id="status-action">Ready</strong></div>
          <div>Reward visible: <strong id="status-reward">No</strong></div>
        </div>
      </section>

      <section class="demo-card">
        <div class="demo-card-header">
          <div class="demo-card-icon">üîê</div>
          <div>
            <div class="demo-card-title">Permissions</div>
            <p class="demo-text-sm">Required for this page.</p>
          </div>
        </div>
        <div class="status-list">
          <div><strong>Scopes:</strong> <code>browser:activeTab.interact</code>, <code>browser:activeTab.read</code></div>
          <div><strong>Feature flag:</strong> <code>browserInteraction</code></div>
        </div>
      </section>
    </div>

    <footer class="demo-footer">
      <a href="../../">‚Üê Back to demos</a>
    </footer>
  </main>

  <script>
    const scrollShell = document.getElementById('scroll-shell');
    const loadMoreBtn = document.getElementById('load-more');
    const revealDelayBtn = document.getElementById('reveal-delay');
    const resetBtn = document.getElementById('scroll-reset');
    const rewardBanner = document.getElementById('reward-banner');
    const statusCount = document.getElementById('status-count');
    const statusAction = document.getElementById('status-action');
    const statusReward = document.getElementById('status-reward');
    const walkthroughStepsEl = document.getElementById('walkthrough-steps');
    const walkthroughNextBtn = document.getElementById('walkthrough-next');
    const walkthroughResetBtn = document.getElementById('walkthrough-reset');
    const walkthroughProgressFill = document.getElementById('progress-fill');
    // getWebAgent() provided by ../shared/agent.js
    let itemCount = 0;
    let revealTimer = null;
    let walkthroughIndex = -1;

    function escapeHtml(text) {
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    const walkthroughSteps = [
      {
        title: 'Detect Web Agent API',
        description: 'Confirm the Web Agent API is available in this page.',
        code: `const agent = window.harbor?.agent ?? window.agent;\nif (!agent) {\n  throw new Error('Web Agent API not detected');\n}`,
        run: async () => {
          const agent = getWebAgent();
          if (!agent) {
            throw new Error('Web Agent API not detected');
          }
          return '‚úì Web Agent API detected';
        }
      },
      {
        title: 'Request permission',
        description: 'Ask for active-tab read + interact access.',
        code: `const agent = window.harbor?.agent ?? window.agent;\nconst result = await agent.requestPermissions({\n  scopes: ['browser:activeTab.interact', 'browser:activeTab.read'],\n  reason: 'Scroll + wait demo'\n});`,
        run: async () => {
          const agent = getWebAgent();
          if (!agent?.requestPermissions) {
            return 'Permission API not available (skipping)';
          }
          const result = await agent.requestPermissions({
            scopes: ['browser:activeTab.interact', 'browser:activeTab.read'],
            reason: 'Scroll + wait demo'
          });
          if (!result.granted) {
            throw new Error('Permission denied');
          }
          return '‚úì Permission granted';
        }
      },
      {
        title: 'Confirm browser control',
        description: 'Verify browser control is available after permissions.',
        code: `const agent = window.harbor?.agent ?? window.agent;\nif (!agent?.browser?.activeTab) {\n  throw new Error('Browser control not available. Enable Browser Control and reload this page.');\n}`,
        run: async () => {
          const agent = getWebAgent();
          if (!agent?.browser?.activeTab) {
            throw new Error('Browser control not available. Enable Browser Control and reload this page.');
          }
          return '‚úì Browser control detected';
        }
      },
      {
        title: 'Interact: scroll list',
        description: 'Scroll within the page to reach deeper items.',
        code: `const agent = window.harbor?.agent ?? window.agent;\nawait agent.browser.activeTab.scroll({ top: 600, behavior: 'smooth' });`,
        run: async () => {
          const agent = getWebAgent();
          await agent.browser.activeTab.scroll({ top: 600, behavior: 'smooth' });
          return '‚úì Scrolled down';
        }
      },
      {
        title: 'Interact: load more',
        description: 'Click load-more and wait for a deep selector.',
        code: `const agent = window.harbor?.agent ?? window.agent;\nawait agent.browser.activeTab.click('#load-more');\nawait agent.browser.activeTab.waitForSelector('#item-18');`,
        run: async () => {
          const agent = getWebAgent();
          await agent.browser.activeTab.click('#load-more');
          await agent.browser.activeTab.waitForSelector('#item-18');
          return '‚úì Loaded more items';
        }
      },
      {
        title: 'Interact: reveal banner',
        description: 'Trigger a delayed element and wait for it.',
        code: `const agent = window.harbor?.agent ?? window.agent;\nawait agent.browser.activeTab.click('#reveal-delay');\nawait agent.browser.activeTab.waitForSelector('#reward-banner.is-visible');`,
        run: async () => {
          const agent = getWebAgent();
          await agent.browser.activeTab.click('#reveal-delay');
          await agent.browser.activeTab.waitForSelector('#reward-banner.is-visible');
          return '‚úì Reward revealed';
        }
      }
    ];

    function renderWalkthroughSteps() {
      walkthroughStepsEl.innerHTML = '';
      walkthroughSteps.forEach((step, index) => {
        const stepEl = document.createElement('div');
        stepEl.className = 'step waiting';
        stepEl.dataset.step = String(index);
        stepEl.innerHTML = `
          <div class="step-icon">${index + 1}</div>
          <div class="step-content">
            <div class="step-title">${step.title}</div>
            <div class="step-description">${step.description}</div>
            <pre class="step-code">${escapeHtml(step.code)}</pre>
            <div class="output-label" style="display: none;">‚Üí Output</div>
            <div class="step-output" style="display: none;"></div>
          </div>
        `;
        walkthroughStepsEl.appendChild(stepEl);
      });
    }

    function setWalkthroughState(index, state, outputText, outputKind) {
      const stepEl = walkthroughStepsEl.querySelector(`[data-step="${index}"]`);
      if (!stepEl) return;
      stepEl.className = `step ${state}`;
      const icon = stepEl.querySelector('.step-icon');
      if (icon) {
        if (state === 'completed') {
          icon.textContent = '‚úì';
        } else if (state === 'error') {
          icon.textContent = '‚úó';
        } else if (state === 'active') {
          icon.innerHTML = '<div class="spinner"></div>';
        } else {
          icon.textContent = index + 1;
        }
      }
      const outputLabel = stepEl.querySelector('.output-label');
      const outputEl = stepEl.querySelector('.step-output');
      if (outputLabel && outputEl) {
        if (outputText) {
          outputLabel.style.display = 'block';
          outputEl.style.display = 'block';
          outputLabel.textContent = outputKind === 'error' ? '‚úó Error' : '‚Üí Output';
          outputEl.className = `step-output ${outputKind || 'success'}`;
          outputEl.textContent = outputText;
        } else {
          outputLabel.style.display = 'none';
          outputEl.style.display = 'none';
          outputEl.textContent = '';
        }
      }
    }

    function updateWalkthroughProgress() {
      const percent = Math.max(0, (walkthroughIndex + 1) / walkthroughSteps.length) * 100;
      walkthroughProgressFill.style.width = `${percent}%`;
    }

    async function runWalkthroughStep() {
      if (walkthroughIndex >= walkthroughSteps.length - 1) return;
      walkthroughIndex += 1;
      updateWalkthroughProgress();
      const current = walkthroughSteps[walkthroughIndex];
      setWalkthroughState(walkthroughIndex, 'active', 'Running...', 'success');
      walkthroughNextBtn.disabled = true;
      walkthroughNextBtn.innerHTML = '<div class="spinner"></div> Running...';

      try {
        const result = await current.run();
        setWalkthroughState(walkthroughIndex, 'completed', result || '‚úì Done', 'success');
      } catch (error) {
        setWalkthroughState(walkthroughIndex, 'error', error.message || 'Step failed', 'error');
        walkthroughIndex -= 1;
        walkthroughNextBtn.disabled = false;
        walkthroughNextBtn.textContent = 'Retry ‚Üí';
        walkthroughResetBtn.style.display = 'inline-flex';
        updateWalkthroughProgress();
        return;
      }

      updateWalkthroughProgress();
      const nextLabel = walkthroughIndex + 2;
      if (walkthroughIndex >= walkthroughSteps.length - 1) {
        walkthroughNextBtn.disabled = true;
        walkthroughNextBtn.textContent = 'Complete! ‚úì';
        walkthroughNextBtn.style.background = 'var(--demo-success)';
        walkthroughResetBtn.style.display = 'inline-flex';
      } else {
        walkthroughNextBtn.disabled = false;
        walkthroughNextBtn.textContent = `Run Step ${nextLabel} ‚Üí`;
        walkthroughNextBtn.style.background = '';
      }
    }

    function resetWalkthrough() {
      walkthroughIndex = -1;
      walkthroughSteps.forEach((_, index) => setWalkthroughState(index, 'waiting'));
      walkthroughNextBtn.disabled = false;
      walkthroughNextBtn.textContent = 'Run Step 1 ‚Üí';
      walkthroughNextBtn.style.background = '';
      walkthroughResetBtn.style.display = 'none';
      updateWalkthroughProgress();
      resetDemo();
    }

    function updateStatus(action) {
      statusCount.textContent = itemCount;
      if (action) statusAction.textContent = action;
      statusReward.textContent = rewardBanner.classList.contains('is-visible') ? 'Yes' : 'No';
    }

    function createCard(index) {
      const card = document.createElement('div');
      card.className = 'scroll-card';
      card.id = `item-${index}`;
      card.innerHTML = `<strong>Queue item ${index}</strong><span>#item-${index}</span>`;
      return card;
    }

    function addItems(count) {
      for (let i = 0; i < count; i += 1) {
        itemCount += 1;
        scrollShell.appendChild(createCard(itemCount));
      }
      updateStatus('Loaded more items');
    }

    function revealReward() {
      rewardBanner.classList.add('is-visible');
      updateStatus('Reward revealed');
    }

    function resetDemo() {
      scrollShell.innerHTML = '';
      itemCount = 0;
      rewardBanner.classList.remove('is-visible');
      if (revealTimer) {
        clearTimeout(revealTimer);
        revealTimer = null;
      }
      addItems(12);
      updateStatus('Reset');
      scrollShell.scrollTop = 0;
    }

    loadMoreBtn.addEventListener('click', () => {
      addItems(6);
    });

    revealDelayBtn.addEventListener('click', () => {
      if (revealTimer) return;
      updateStatus('Waiting for reveal');
      revealTimer = setTimeout(() => {
        revealReward();
        revealTimer = null;
      }, 1200);
    });

    resetBtn.addEventListener('click', resetDemo);
    walkthroughNextBtn.addEventListener('click', runWalkthroughStep);
    walkthroughResetBtn.addEventListener('click', resetWalkthrough);

    renderWalkthroughSteps();
    resetWalkthrough();
  </script>
</body>
</html>
